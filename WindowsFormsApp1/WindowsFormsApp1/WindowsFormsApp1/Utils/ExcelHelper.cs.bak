using System;
using System.Collections.Generic;
using System.IO;
using System.Windows.Forms;
using WindowsFormsApp1.Models;
using System.Data;
using System.Diagnostics;
using System.Text;

namespace WindowsFormsApp1.Utils
{
    /// <summary>
    /// Utility class for Excel export functionality using CSV format for compatibility
    /// </summary>
    public static class ExcelHelper
    {
        /// <summary>
    /// Export Employee list to Excel (CSV format for compatibility)
        /// </summary>
     public static void ExportEmployeesToExcel(List<Employee> employees, string fileName = null)
 {
        try
            {
             if (employees == null || employees.Count == 0)
   {
   MessageBox.Show("Không có d? li?u ?? xu?t!", "Thông báo", 
        MessageBoxButtons.OK, MessageBoxIcon.Information);
     return;
            }

       // Get save file path
         string filePath = GetSaveFilePath(fileName ?? "DanhSachNhanVien", "csv");
     if (string.IsNullOrEmpty(filePath)) return;

       // Create CSV content
        StringBuilder csvContent = new StringBuilder();
      
 // Add UTF-8 BOM for proper Vietnamese character display
  csvContent.AppendLine("sep=,");              
   // Add headers
                csvContent.AppendLine("STT,Mã NV,H? Tên,Gi?i Tính,Ngày Sinh,Tu?i,Ch?c V?,Phòng Ban,L??ng (VND),Tr?ng Thái");

  // Add data
    for (int i = 0; i < employees.Count; i++)
        {
 var emp = employees[i];
      csvContent.AppendLine($"{i + 1}," +
   $"\"{emp.EmployeeCode ?? ""}\"," +
       $"\"{emp.FullName}\"," +
 $"\"{emp.Gender}\"," +
       $"\"{emp.DateOfBirth:dd/MM/yyyy}\"," +
             $"{emp.Age}," +
    $"\"{emp.Position}\"," +
          $"\"{emp.DepartmentDisplay ?? ""}\"," +
     $"{emp.Salary:N0}," +
        $"\"{emp.Status}\"");
           }

        // Write to file with UTF-8 encoding
       File.WriteAllText(filePath, csvContent.ToString(), Encoding.UTF8);

   MessageBox.Show($"Xu?t Excel thành công!\nFile ?ã ???c l?u t?i: {filePath}", 
    "Thành công", MessageBoxButtons.OK, MessageBoxIcon.Information);

         // Open file location
    Process.Start("explorer.exe", "/select,\"" + filePath + "\"");
     }
  catch (Exception ex)
    {
  MessageBox.Show($"L?i khi xu?t Excel: {ex.Message}", "L?i", 
       MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
        }

        /// <summary>
        /// Export Department list to Excel (CSV format)
    /// </summary>
        public static void ExportDepartmentsToExcel(List<Department> departments, string fileName = null)
{
         try
    {
          if (departments == null || departments.Count == 0)
          {
   MessageBox.Show("Không có d? li?u ?? xu?t!", "Thông báo", 
           MessageBoxButtons.OK, MessageBoxIcon.Information);
    return;
     }

  // Get save file path
     string filePath = GetSaveFilePath(fileName ?? "DanhSachPhongBan", "csv");
    if (string.IsNullOrEmpty(filePath)) return;

   // Create CSV content
          StringBuilder csvContent = new StringBuilder();
         
       // Add UTF-8 BOM for proper Vietnamese character display
           csvContent.AppendLine("sep=,");        
       // Add headers
                csvContent.AppendLine("STT,Mã Phòng Ban,Tên Phòng Ban,Tr??ng Phòng,S? Nhân Viên,??a ?i?m,?i?n Tho?i,Email,Tr?ng Thái");

        // Add data
      for (int i = 0; i < departments.Count; i++)
  {
         var dept = departments[i];
      csvContent.AppendLine($"{i + 1}," +
 $"\"{dept.DepartmentCode ?? ""}\"," +
   $"\"{dept.DepartmentName}\"," +
                 $"\"{dept.ManagerName ?? "Ch?a có"}\"," +
     $"{dept.EmployeeCount}," +
  $"\"{dept.Location ?? ""}\"," +
             $"\"{dept.PhoneNumber ?? ""}\"," +
      $"\"{dept.Email ?? ""}\"," +
              $"\"{(dept.IsActive ? "Ho?t ??ng" : "Không ho?t ??ng")}\"");
}

        // Write to file with UTF-8 encoding
            File.WriteAllText(filePath, csvContent.ToString(), Encoding.UTF8);

           MessageBox.Show($"Xu?t Excel thành công!\nFile ?ã ???c l?u t?i: {filePath}", 
    "Thành công", MessageBoxButtons.OK, MessageBoxIcon.Information);

            // Open file location
Process.Start("explorer.exe", "/select,\"" + filePath + "\"");
    }
            catch (Exception ex)
     {
     MessageBox.Show($"L?i khi xu?t Excel: {ex.Message}", "L?i", 
          MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

  /// <summary>
  /// Export Attendance list to Excel (CSV format)
        /// </summary>
        public static void ExportAttendanceToExcel(List<Attendance> attendanceList, DateTime fromDate, DateTime toDate, string fileName = null)
        {
try
            {
      if (attendanceList == null || attendanceList.Count == 0)
      {
              MessageBox.Show("Không có d? li?u ?? xu?t!", "Thông báo", 
    MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
      }

     // Get save file path
        string defaultFileName = fileName ?? $"BangChamCong_{fromDate:ddMMyyyy}_{toDate:ddMMyyyy}";
string filePath = GetSaveFilePath(defaultFileName, "csv");
    if (string.IsNullOrEmpty(filePath)) return;

       // Create CSV content
   StringBuilder csvContent = new StringBuilder();
         
          // Add UTF-8 BOM for proper Vietnamese character display
     csvContent.AppendLine("sep=,");
        
              // Add title
           csvContent.AppendLine($"B?NG CH?M CÔNG T? {fromDate:dd/MM/yyyy} ??N {toDate:dd/MM/yyyy}");
                csvContent.AppendLine(); // Empty line
                
// Add headers
                csvContent.AppendLine("STT,Mã NV,H? Tên,Phòng Ban,Ngày,Gi? Vào,Gi? Ra,S? Gi? Làm,Tr?ng Thái,Ghi Chú");

// Add data
          for (int i = 0; i < attendanceList.Count; i++)
        {
         var att = attendanceList[i];
       csvContent.AppendLine($"{i + 1}," +
    $"\"{att.EmployeeCode ?? ""}\"," +
   $"\"{att.EmployeeName ?? ""}\"," +
         $"\"{att.DepartmentName ?? ""}\"," +
          $"\"{att.AttendanceDate:dd/MM/yyyy}\"," +
 $"\"{att.CheckInTime:HH:mm}\"," +
     $"\"{(att.CheckOutTime?.ToString("HH:mm") ?? "")}\"," +
          $"\"{(att.WorkingHours?.ToString("0.0") ?? "0")}\"," +
      $"\"{GetAttendanceStatusText(att.Status)}\"," +
       $"\"{att.Notes ?? ""}\"");
           }

      // Write to file with UTF-8 encoding
File.WriteAllText(filePath, csvContent.ToString(), Encoding.UTF8);

         MessageBox.Show($"Xu?t Excel thành công!\nFile ?ã ???c l?u t?i: {filePath}", 
              "Thành công", MessageBoxButtons.OK, MessageBoxIcon.Information);

    // Open file location
          Process.Start("explorer.exe", "/select,\"" + filePath + "\"");
       }
    catch (Exception ex)
 {
        MessageBox.Show($"L?i khi xu?t Excel: {ex.Message}", "L?i", 
    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

   /// <summary>
        /// Get file path for saving Excel file
        /// </summary>
     private static string GetSaveFilePath(string defaultFileName, string extension = "xlsx")
 {
            using (SaveFileDialog saveDialog = new SaveFileDialog())
            {
       if (extension.ToLower() == "csv")
       {
           saveDialog.Filter = "CSV Files (*.csv)|*.csv|Excel Files (*.xlsx)|*.xlsx|Excel 97-2003 (*.xls)|*.xls";
 saveDialog.DefaultExt = "csv";
  }
           else
         {
          saveDialog.Filter = "Excel Files (*.xlsx)|*.xlsx|Excel 97-2003 (*.xls)|*.xls|CSV Files (*.csv)|*.csv";
         saveDialog.DefaultExt = "xlsx";
        }
      
          saveDialog.FilterIndex = 1;
    saveDialog.FileName = $"{defaultFileName}_{DateTime.Now:yyyyMMdd_HHmmss}";
       saveDialog.AddExtension = true;
   saveDialog.Title = "Ch?n n?i l?u file Excel";

     // Set default save location to Desktop
 saveDialog.InitialDirectory = Environment.GetFolderPath(Environment.SpecialFolder.Desktop);

       if (saveDialog.ShowDialog() == DialogResult.OK)
       {
    return saveDialog.FileName;
    }
            }

    return string.Empty;
        }

        /// <summary>
 /// Convert attendance status to Vietnamese text
        /// </summary>
        private static string GetAttendanceStatusText(string status)
  {
    switch (status?.ToLower())
            {
      case "present":
return "Có m?t";
 case "late":
           return "?i mu?n";
                case "absent":
       return "V?ng m?t";
       case "leave":
    return "Ngh? phép";
     default:
   return status ?? "";
      }
 }
    }
}